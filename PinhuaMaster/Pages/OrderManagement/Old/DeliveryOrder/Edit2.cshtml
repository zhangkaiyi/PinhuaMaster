@page "{Id?}"
@model PinhuaMaster.Pages.OrderManagement.Old.DeliveryOrder.Edit2Model
@{
    ViewData["Title"] = "Edit2";

    var emptyRecord = Newtonsoft.Json.JsonConvert.SerializeObject(new CreateModel.ItemModel
    {
        Unit = "平方米",
    });
    var emptyRecordList = Newtonsoft.Json.JsonConvert.SerializeObject(Model?.Input?.DeliveryItems ?? new List<CreateModel.ItemModel>());
}

<div id="vueScope" v-cloak>
    <form method="post" id="myForm">
        <section class="invoice" id="invoice" style="margin:0px;margin-bottom:20px;">
            <div class="row">
                <div class="col-xs-12">
                    <h2 class="page-header">
                        <i class="fa fa-globe"></i> 胜美木业, Inc.
                        @*<small class="pull-right">Date:  @DateTime.UtcNow.ToString("yyyy/M/d")</small>*@
                    </h2>
                </div>
                <!-- /.col -->
            </div>
            <!-- info row -->
            <div class="row invoice-info">
                <div class="col-sm-4 invoice-col">
                    <div class="form-group has-error">
                        <label class="control-label" asp-for="Input.DeliveryType"><i class="fa fa-angle-double-right"></i> @Html.DisplayNameFor(x => x.Input.DeliveryType)</label>
                        <div class="input-group">
                            <select class="form-control" name="Input.DeliveryType" asp-for="Input.DeliveryType" asp-items="Model.DeliveryTypes"></select>
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-danger btn-flat" style="width:40px"><i class="fa fa-bars"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="form-group has-error">
                        <label class="control-label" asp-for="Input.CustomerId"><i class="fa fa-angle-double-right"></i> @Html.DisplayNameFor(x => x.Input.CustomerId)</label>
                        <div class="input-group">
                            <select class="form-control" name="Input.CustomerId" asp-for="Input.CustomerId" asp-items="Model.Customers"></select>
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-danger btn-flat" style="width:40px"><i class="fa fa-truck"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="form-group has-error">
                        <label class="control-label" asp-for="Input.DeliveryDate"><i class="fa fa-angle-double-right"></i> @Html.DisplayNameFor(x => x.Input.DeliveryDate)</label>
                        <div class="input-group">
                            <input type="text" asp-for="Input.DeliveryDate" data-provide="datepicker" data-date-format="yyyy-mm-dd" readonly class="form-control pull-right" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-danger btn-flat" style="width:40px"><i class="fa fa-calendar-o"></i></button>
                            </span>
                        </div>
                        <span class="help-block" asp-validation-for="Input.DeliveryDate"></span>
                    </div>
                    <div class="form-group has-error">
                        <label class="control-label" asp-for="Input.DeliveryAddress"><i class="fa fa-angle-double-right"></i> 地址</label>
                        <div class="input-group">
                            <input asp-for="Input.DeliveryAddress" class="form-control" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-danger btn-flat" style="width:40px"><i class="fa fa-map-o"></i></button>
                            </span>
                        </div>
                    </div>
                </div>
                <!-- /.col -->
                <div class="col-sm-4 invoice-col">
                    <div class="form-group has-warning">
                        <label class="control-label" asp-for="Input.Contact"><i class="fa fa-angle-double-right"></i> @Html.DisplayNameFor(x => x.Input.Contact)</label>
                        <div class="input-group">
                            <input type="text" asp-for="Input.Contact" class="form-control" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-warning btn-flat" style="width:40px"><i class="fa fa-user"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="form-group has-warning">
                        <label class="control-label" asp-for="Input.ContactNumber"><i class="fa fa-angle-double-right"></i> @Html.DisplayNameFor(x => x.Input.ContactNumber)</label>
                        <div class="input-group">
                            <input type="text" asp-for="Input.ContactNumber" class="form-control" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-warning btn-flat" style="width:40px"><i class="fa fa-phone"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="form-group has-warning">
                        <label class="control-label" asp-for="Input.Remarks">
                            <i class="fa fa-bell-o"></i> @Html.DisplayNameFor(x => x.Input.Remarks)
                        </label>
                        <div class="input-group">
                            <textarea asp-for="Input.Remarks" class="form-control" rows="3"></textarea>
                            <span class="input-group-addon"><i class="fa fa-ellipsis-h"></i></span>
                        </div>
                        <span class="help-block">在此输入你的备注信息</span>
                    </div>
                </div>
                <!-- /.col -->
                <div class="col-sm-4 invoice-col">
                    <div class="form-group">
                        <label class="control-label" asp-for="Input.DeliveryId"><i class="fa fa-angle-double-right"></i> @Html.DisplayNameFor(x => x.Input.DeliveryId)</label>
                        <div class="input-group">
                            <input type="text" asp-for="Input.DeliveryId" class="form-control" readonly />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-flat" style="width:40px"><i class="fa fa-sticky-note-o"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label" asp-for="Input.CreatedBy"><i class="fa fa-angle-double-right"></i> @Html.DisplayNameFor(x => x.Input.CreatedBy)</label>
                        <div class="input-group">
                            <input type="text" asp-for="Input.CreatedBy" class="form-control" readonly />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-flat" style="width:40px"><i class="fa fa-user-o"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label" asp-for="Input.CreatedDate"><i class="fa fa-angle-double-right"></i> @Html.DisplayNameFor(x => x.Input.CreatedDate)</label>
                        <div class="input-group">
                            <input type="text" asp-for="Input.CreatedDate" class="form-control" readonly />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-flat" style="width:40px"><i class="fa fa-calendar-o"></i></button>
                            </span>
                        </div>
                    </div>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
            <!-- /.row -->
        </section>
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <div class="box-title">出库清单</div>
                        <div class="box-tools pull-right">
                            <a class="btn btn-primary btn-sm btn-flat" data-toggle="modal" data-target="#myModal" v-on:click="newRecord">
                                <i class="fa fa-plus"></i>　添加明细
                            </a>
                        </div>
                    </div>
                    <div class="box-body no-padding" v-if="">
                        <div>
                            <table class="table table-striped table-bordered" id="formTable" style="">
                                <thead>
                                    <tr>
                                        <th style="max-width:20px">#</th>
                                        <th style="min-width:80px;">描述</th>
                                        <th style="min-width:80px;">规格</th>
                                        <th class="hidden-xs" style="min-width:80px;">长</th>
                                        <th class="hidden-xs" style="min-width:80px;">宽</th>
                                        <th class="hidden-xs" style="min-width:80px;">高</th>
                                        <th style="min-width:80px;">片数</th>
                                        <th class="hidden-xs" style="min-width:80px;">单位数量</th>
                                        <th class="hidden-xs" style="min-width:80px;">计价单位</th>
                                        <th class="hidden-xs" style="min-width:80px;">单价</th>
                                        <th class="hidden-xs" style="min-width:80px;">金额</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="items.length == 0"><td colspan="20" class="text-center">出库清单空</td></tr>
                                    <tr v-for="(todo,index) in items">
                                        <td>{{ index + 1 }}<input :name="buildName(index,'Index')" type="hidden" v-bind:value="index + 1" /></td>
                                        <td>{{ todo.Description }}<input :name="buildName(index,'Description')" type="hidden" v-model="todo.Description" /></td>
                                        <td>{{ computeSpecification(todo) }}<input :name="buildName(index,'Specification')" type="hidden" v-bind:value="computeSpecification(todo)" /></td>
                                        <td class="hidden-xs">{{ todo.Length }}<input :name="buildName(index,'Length')" type="hidden" v-bind:value="todo.Length" /></td>
                                        <td class="hidden-xs">{{ todo.Width }}<input :name="buildName(index,'Width')" type="hidden" v-bind:value="todo.Width" /></td>
                                        <td class="hidden-xs">{{ todo.Height }}<input :name="buildName(index,'Height')" type="hidden" v-bind:value="todo.Height" /></td>
                                        <td>{{ todo.Qty }}<input :name="buildName(index,'Qty')" type="hidden" v-bind:value="todo.Qty" /></td>
                                        <td class="hidden-xs">{{ computeUnitQty(todo) }}<input :name="buildName(index,'UnitQty')" type="hidden" v-bind:value="computeUnitQty(todo)" /></td>
                                        <td class="hidden-xs">{{ todo.Unit }}<input :name="buildName(index,'Unit')" type="hidden" v-bind:value="todo.Unit" /></td>
                                        <td class="hidden-xs">{{ todo.Price }}<input :name="buildName(index,'Price')" type="hidden" v-bind:value="todo.Price" /></td>
                                        <td class="hidden-xs">{{ computeAmount(todo) }}<input :name="buildName(index,'Amount')" type="hidden" v-bind:value="computeAmount(todo)" /></td>
                                        <td class="no-padding text-center" style="vertical-align: middle;">
                                            @*<button type="button" class="btn btn-xs btn-primary btn-flat" data-toggle="modal" data-target="#myModal" v-on:click="editRecord(index)">修改</button>
                                                <button type="button" class="btn btn-xs btn-danger btn-flat" v-on:click="removeTodo(index)">移除</button>*@
                                            <div class="dropdown">
                                                <button type="button" class="btn btn-xs btn-danger btn-flat dropdown-toggle" style="width:30px" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button>
                                                <ul class="dropdown-menu dropdown-menu-right">
                                                    <li><a data-toggle="modal" data-target="#myModal" v-on:click="editRecord(index)">修改</a></li>
                                                    <li><a v-on:click="removeTodo(index)">移除</a></li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.col -->
        </div>
    </form>
    <a class="btn btn-default btn-flat" href="javascript:$('#myForm').submit();"><i class="fa fa-check"></i>&nbsp;提交</a>

    <!-- Modal -->
    <div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">编辑物料</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal">
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 描述</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input class="form-control" v-model="itemCurrent.Description" />
                                    <div class="input-group-addon no-padding">
                                        <i class="fa fa-info" style="width:38px;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @*<div class="form-group has-error">
                                <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 规格</label>
                                <div class="col-xs-8 col-md-9">
                                    <div class="input-group">
                                        <input class="form-control" v-bind:value="selectedItemSpecification" />
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-danger btn-flat" style="width:40px"><i class="fa fa-info"></i></button>
                                        </span>
                                    </div>
                                </div>
                            </div>*@
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 长</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" v-model="itemCurrent.Length" />
                                    <div class="input-group-btn">
                                        <button type="button" class="btn btn-danger btn-flat dropdown-toggle" style="width:40px" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button>
                                        <ul class="dropdown-menu dropdown-menu-right">
                                            <li><a v-on:click="itemCurrent.Length=450">450</a></li>
                                            <li><a v-on:click="itemCurrent.Length=500">500</a></li>
                                            <li><a v-on:click="itemCurrent.Length=600">600</a></li>
                                            <li><a v-on:click="itemCurrent.Length=300">300</a></li>
                                        </ul>
                                        @*<button type="button" class="btn btn-danger btn-flat" style="width:40px"><i class="fa fa-sort-numeric-asc"></i></button>*@
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 宽</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" v-model="itemCurrent.Width" />
                                    <div class="input-group-btn">
                                        <button type="button" class="btn btn-danger btn-flat dropdown-toggle" style="width:40px" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button>
                                        <ul class="dropdown-menu dropdown-menu-right">
                                            <li><a v-on:click="itemCurrent.Width=450">450</a></li>
                                            <li><a v-on:click="itemCurrent.Width=500">500</a></li>
                                            <li><a v-on:click="itemCurrent.Width=600">600</a></li>
                                            <li><a v-on:click="itemCurrent.Width=300">300</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 高</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" v-model="itemCurrent.Height" />
                                    <div class="input-group-btn">
                                        <button type="button" class="btn btn-danger btn-flat dropdown-toggle" style="width:40px" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button>
                                        <ul class="dropdown-menu dropdown-menu-right">
                                            <li><a v-on:click="itemCurrent.Height=15">15</a></li>
                                            <li><a v-on:click="itemCurrent.Height=18">18</a></li>
                                            <li><a v-on:click="itemCurrent.Height=12">12</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 数量</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" v-model="itemCurrent.Qty" />
                                    <div class="input-group-addon no-padding">
                                        <i class="fa fa-calculator" style="width:38px"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 单位数量</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" v-bind:value="selectedItemUnitQty" />
                                    <div class="input-group-btn">
                                        <button type="button" class="btn btn-danger btn-flat dropdown-toggle" style="width:80px" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            {{ itemCurrent.Unit }}
                                            <span class="caret"></span>
                                            <span class="sr-only">Toggle Dropdown</span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-right">
                                            <li><a v-on:click="itemCurrent.Unit='PCS'">PCS</a></li>
                                            <li><a v-on:click="itemCurrent.Unit='平方米'">平方米</a></li>
                                            <li><a v-on:click="itemCurrent.Unit='立方米'">立方米</a></li>
                                            <li><a v-on:click="itemCurrent.Unit='延长米'">延长米</a></li>
                                            <li><a v-on:click="itemCurrent.Unit='套'">套</a></li>
                                        </ul>
                                    </div>
                                    @*<div class="input-group-addon no-padding">
                                            <i class="fa fa-calculator" style="width:38px"></i>
                                        </div>*@
                                </div>
                            </div>
                        </div>
                        @*<div class="form-group has-error">
                                <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 单位</label>
                                <div class="col-xs-8 col-md-9">
                                    <div class="input-group">
                                        <select class="form-control" v-model="itemCurrent.Unit">
                                            <option>PCS</option>
                                            <option>平方米</option>
                                            <option>延长米</option>
                                            <option>立方米</option>
                                            <option>套</option>
                                        </select>
                                        <span class="input-group-addon no-padding">
                                            <i class="fa fa-calculator" style="width:38px"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>*@
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 单价</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" v-model="itemCurrent.Price" />
                                    <span class="input-group-addon no-padding">
                                        <i class="fa fa-usd" style="width:38px"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 金额</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" v-bind:value="selectedItemAmount" />
                                    <span class="input-group-addon no-padding">
                                        <i class="fa fa-usd" style="width:38px"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group has-error">
                            <label class="control-label col-xs-4 col-md-3"><i class="fa fa-angle-double-right"></i> 备注</label>
                            <div class="col-xs-8 col-md-9">
                                <div class="input-group">
                                    <input class="form-control" v-model="itemCurrent.Remarks" />
                                    <div class="input-group-addon no-padding">
                                        <i class="fa fa-ellipsis-h" style="width:38px"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-flat" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default btn-flat" data-dismiss="modal" v-if="isNew" v-on:click="saveNewRecord">新增</button>
                    <button type="button" class="btn btn-default btn-flat" data-dismiss="modal" v-if="!isNew" v-on:click="saveEditRecord">修改</button>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script>
        var emptyRecord = @Html.Raw(emptyRecord);
        var emptyRecordList = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(emptyRecordList));
        var vm = new Vue({
            el: '#vueScope',
            data: {
                items: @(Html.Raw(emptyRecordList)),
                itemCurrent: {},
                itemIndex: {},
                isNew: false,
                trEdit: -1,
            },
            computed: {
                visible: function () {
                    return this.items.length > 0
                },
                selectedItemSpecification: function () {
                    var result = this.computeSpecification(this.itemCurrent)
                    this.itemCurrent.Specification = result
                    return result
                },
                selectedItemUnitQty: function () {
                    var result = this.computeUnitQty(this.itemCurrent)
                    this.itemCurrent.UnitQty = result
                    return result
                },
                selectedItemAmount: function () {
                    var result = this.computeAmount(this.itemCurrent)
                    this.itemCurrent.Amount = result
                    return result
                }
            },
            methods: {
                buildName: function (index, name) {
                    return "Input.DeliveryItems[" + index + "]." + name
                },
                newRecord: function () {
                    this.isNew = true;
                    this.itemCurrent = JSON.parse(JSON.stringify(emptyRecord))
                },
                saveNewRecord: function () {
                    this.items.push(this.itemCurrent);
                },
                editRecord: function (index) {
                    this.isNew = false;
                    this.itemIndex = index;
                    this.itemCurrent = JSON.parse(JSON.stringify(this.items[index]))
                },
                saveEditRecord: function () {
                    this.$set(this.items, this.itemIndex, this.itemCurrent)

                },
                removeTodo: function (index) {
                    this.items.splice(index, 1)
                },
                computeSpecification: function (item) {
                    if (!item.Length || !item.Width || !item.Height)
                        return ""
                    return [item.Length, item.Width, item.Height].join("x")
                },
                computeUnitQty: function (item) {
                    if (!item.Qty || !item.Unit || !item.Length || !item.Width || !item.Height)
                        return ""
                    var result = 0
                    if (item.Unit == 'PCS')
                        result = item.Qty
                    else if (item.Unit == '平方米')
                        result = item.Qty * item.Length * item.Width / 1000 / 1000
                    else if (item.Unit == '立方米')
                        result = item.Qty * item.Length * item.Width * item.Height / 1000 / 1000 / 1000
                    else if (item.Unit == '延长米')
                        result = item.Qty * item.Length / 1000
                    result = result || ""
                    return new Number(result).toFixed(4)
                },
                computeAmount: function (item) {
                    if (!item.UnitQty || !item.Price)
                        return ""
                    return parseFloat(item.UnitQty * item.Price).toFixed(2)

                }
            }
        })
    </script>
}
@section Styles{
    <style>
        [v-cloak] {
            display: none;
        }

        .form-horizontal .control-label {
            text-align: right;
            margin-bottom: 0;
            padding-top: 7px;
        }

        body.modal-open {
            position: fixed;
            overflow: hidden;
            left: 0;
            right: 0;
        }

        .modal {
            -webkit-overflow-scrolling: auto;
        }
    </style>
}